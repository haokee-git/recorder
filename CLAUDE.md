# Recorder 项目规格说明

## 项目概述

**项目名称**：Recorder
**包名**：org.haokee.recorder
**类型**：Android 原生应用
**核心价值**：让用户随时随地用录音记录想法，闲暇时转换为文本整理

---

## 核心概念：感言（Thought）

感言是本应用的核心数据单元，分为两种状态：

### 1. 原始感言（Original Thought）
- **形式**：音频录音文件
- **存储**：本地文件系统
- **可操作**：播放、删除、转换为文本、设置提醒、标记颜色

### 2. 转换后感言（Translated Thought）
- **属性**：
  - `title`（标题）：文本字符串
  - `content`（内容）：文本字符串
  - `audioPath`（音频路径）：原始录音文件路径
  - `color`（颜色标记）：枚举值（红/橙/黄/绿/青/蓝/紫/黑）
  - `alarmTime`（提醒时间）：可选的 DateTime
  - `createdAt`（创建时间）：DateTime
  - `transcribedAt`（转换时间）：DateTime

---

## 功能规格

### 一、录音管理

#### 录音功能
- 点击录音按钮开始录制
- 再次点击停止并保存
- 音频格式：建议使用 AAC/M4A（兼容性好，文件小）
- 存储位置：应用私有目录

#### 批量操作
- **多选模式**：点击感言左侧的圆角矩形选择框进入多选模式
- **批量转换**：将多条原始感言转换为文本
- **批量删除**：删除选中的感言（需二次确认）
- **批量设置颜色**：为选中的感言统一设置颜色
- **批量设置提醒**：为选中的感言设置相同的提醒时间

### 二、语音转文本

#### 技术实现
- **API**：Android 原生 `SpeechRecognizer`
- **触发方式**：
  - 单条：点击感言的"转换"按钮
  - 批量：选中多条后点击工具栏"批量转换"按钮
- **转换逻辑**：
  1. 调用 SpeechRecognizer 识别音频
  2. 获取文本结果
  3. 默认 `title = content = 识别文本`
  4. 如果启用大模型 API，调用大模型生成标题
  5. 保存到数据库，状态变为"已转换"

#### 手动编辑
- **单选模式**：选中单条感言时，启用"编辑"按钮（蓝色可点击）
- **多选模式**：选中多条感言时，"编辑"按钮灰色禁用
- **编辑界面**：弹出对话框，可修改标题和内容

### 三、大模型集成

#### API 配置
- **协议**：OpenAI 兼容接口
- **配置项**：
  - Base URL（支持自定义或预设）
  - API Key（用户自己提供）
  - 启用/禁用开关
- **功能**：
  - **生成标题**：基于 content 总结出简短标题
  - **对话功能**：侧边栏聊天（单轮对话，支持清除上下文）

#### 对话界面
- **位置**：左侧抽屉式弹出页面
- **功能**：
  - 发送消息到大模型
  - 显示 AI 回复（支持 Markdown 渲染）
  - "清除上下文"按钮：用分割线表示，但不删除历史消息显示
  - 不支持多轮上下文（每次发送独立请求）

### 四、提醒功能

#### 闹钟设置
- **实现方式**：使用 Android `AlarmManager` 设置系统闹钟
- **唤醒能力**：即使设备休眠也能响铃
- **闹钟标题**：
  - 已转换感言：使用感言的 `title`
  - 原始感言：使用默认文本"感言提醒"
- **批量设置**：可为多条感言设置相同时间

#### 闹钟管理
- **已过期闹钟**：在列表中以灰色显示
- **取消闹钟**：支持单独取消或批量取消

### 五、颜色标记

- **颜色选项**：红、橙、黄、绿、青、蓝、紫、黑（共 8 种）
- **显示样式**：小圆形纯色块，位于播放按钮左侧
- **筛选功能**：
  - 工具栏右侧筛选按钮
  - 可多选颜色进行筛选
  - 全选/全不选快捷按钮

---

## UI/UX 设计规范

### 主题风格
- **默认主题**：浅色（Light Mode）
- **可选主题**：暗色（Dark Mode）
- **主色调**：蓝色系
- **设计理念**：现代、简洁、优雅

### 布局结构

#### 1. 顶部标题栏（固定）
```
[大模型对话按钮] [Recorder 大标题] [设置按钮]
                [记录一时感言 小标题]
```

- **大模型对话按钮**：点击后左侧滑出抽屉式对话页面
- **设置按钮**：打开设置页面

#### 2. 工具栏（固定）
```
[批量转换] [设置提醒] [设置颜色] [删除]    [筛选按钮]
```

- **按钮状态**：
  - 未选中感言：所有按钮灰色禁用
  - 选中单条：所有按钮启用
  - 选中多条："编辑"按钮禁用，其他启用
- **筛选按钮**：展开颜色筛选面板

#### 3. 感言列表（可滚动）

**分为三个区域**：

1. **已转换感言**
   - 左侧：圆角矩形选择框
   - 中间：标题、内容预览、声波图像、播放进度、录音长度
   - 右侧：颜色标记（小圆形）、播放按钮
   - 显示创建时间和提醒时间（如果有）

2. **原始感言**
   - 左侧：圆角矩形选择框
   - 中间：声波图像、播放进度、录音时长
   - 右侧：颜色标记（小圆形）、播放按钮
   - 显示"未转换"标签、创建时间

3. **闹钟已过的感言**
   - 灰色显示
   - 其他信息同上

#### 4. 录音按钮（浮动）
- **位置**：屏幕右下角 FAB（Floating Action Button）
- **样式**：蓝色圆形按钮，麦克风图标
- **状态**：
  - 未录音：蓝色，麦克风图标
  - 录音中：红色，方块图标（停止）

### 设置页面

**选项列表**：

1. **大模型 API 设置**
   - 启用/禁用开关
   - Base URL 输入框（或预设选择）
   - API Key 输入框
   - 测试连接按钮

2. **界面主题**
   - 亮色/暗色切换

3. **数据管理**
   - 清除所有感言按钮（红色，需二次确认）

4. **关于**
   - 显示应用版本号

---

## 技术实现要点

### 数据存储
- **数据库**：使用 Room 或 SQLite 存储感言元数据
- **文件存储**：音频文件存储在应用私有目录

### 权限需求
- `RECORD_AUDIO`：录音权限
- `SCHEDULE_EXACT_ALARM`：精确闹钟权限（Android 12+）
- `POST_NOTIFICATIONS`：通知权限（Android 13+）

### 关键库/API
- **录音**：Android MediaRecorder
- **语音识别**：Android SpeechRecognizer
- **闹钟**：AlarmManager
- **网络请求**：Retrofit/OkHttp（调用大模型 API）
- **Markdown 渲染**：Markwon 或类似库

---

## 开发优先级建议

### Phase 1: 核心功能
1. 录音与播放
2. 感言列表展示
3. 基本的增删改查

### Phase 2: 语音转文本
1. 集成 SpeechRecognizer
2. 单条/批量转换
3. 手动编辑功能

### Phase 3: 高级功能
1. 大模型 API 集成
2. 闹钟提醒
3. 颜色标记与筛选

### Phase 4: 体验优化
1. 主题切换
2. 对话功能
3. UI/UX 细节打磨

---

## 代码规范提示

- **语言**：Kotlin（推荐）或 Java
- **架构**：推荐使用 MVVM 或 MVI
- **命名约定**：
  - 数据类：`Thought`, `ThoughtColor`, `AlarmInfo`
  - ViewModel：`ThoughtListViewModel`, `SettingsViewModel`
  - Repository：`ThoughtRepository`
- **错误处理**：网络请求和语音识别需要完善的错误提示

---

## AI 助手开发指南

在为本项目编写代码时，请遵循以下原则：

1. **优先阅读现有代码**：在修改功能前，先用 Read 工具查看相关文件
2. **遵循项目架构**：保持代码风格一致，遵循已有的架构模式
3. **完整实现功能**：每个功能应包含完整的错误处理和用户反馈
4. **注重用户体验**：
   - 按钮状态应准确反映可用性（启用/禁用）
   - 异步操作要显示加载状态
   - 错误信息要清晰友好
5. **安全第一**：
   - API Key 应安全存储（使用 EncryptedSharedPreferences）
   - 权限请求要有明确说明
   - 数据删除操作需二次确认
6. **版本管理**：在完成阶段性开发后先暂存所有更改，然后进行一次提交（提交信息有意义）。不推送到远程仓库。
7. **构建规则**：修改完代码之后不要自己运行命令构建，而是由我手动构建。
8. **文档更新规则**：**每次接收到修改需求时，必须先更新本文档（CLAUDE.md）**，将需求变更记录到"需求变更记录"章节。这是强制要求。

---

## 需求变更记录

### 2026-01-28 - UI/UX 重大改进

#### 1. 播放器改进
- **问题修复**：播放暂停后图标未从暂停符号变回播放符号
- **新增功能**：
  - 为每条录音添加声波图像可视化（类似音频处理软件）
  - 在声波图像上显示播放进度竖线
  - 显示录音长度信息

#### 2. 时间选择器重新设计
- **旧设计**：简单的文本输入框
- **新设计**：
  - 年月选择：点击弹出浮动框切换年份和月份
  - 日期选择：半圆形轮盘式滑动调整，流畅动画
  - 时间选择：半圆形轮盘式滑动调整（小时和分钟）
  - 需要正确计算大月小月、平年闰年

#### 3. 颜色标记 UI 优化
- **调整内容**：
  - 缩小颜色圆形半径（原来太大）
  - 将颜色圆形移至播放按钮左侧（提升美观度）

#### 4. 选择逻辑改进
- **旧设计**：长按进入多选模式
- **新设计**：
  - 在每条感言左侧添加圆角矩形选择框
  - 默认不选中状态
  - 通过点击选择框实现多选
  - 移除长按选择逻辑

#### 5. Bug 修复
- **闹钟设置闪退**：设置闹钟时应用崩溃，需要定位并修复（过期功能正常）
- **闹钟通知**：设置闹钟后未收到系统通知，需要检查权限和通知实现

---

### 2026-01-29 - 时间选择器重新设计（垂直滚轮）

#### 需求背景
将时间选择器从半圆形轮盘改为 iOS 风格的垂直滚轮选择器（Drum Roll Picker），提升用户体验和交互自然度。

#### 设计规格

**1. 布局分组**
- **第一组**：年/月/日（大字展示，用 `/` 分割）
  - 三列垂直滚轮：年、月、日
- **第二组**：时:分（大字展示，用 `:` 分割）
  - 两列垂直滚轮：小时、分钟

**2. 滚轮视觉效果**
- **中心行**：
  - 黑色粗体
  - 最大字号
  - 当前选中值
- **上下相邻行**：
  - 中等灰色
  - 字号稍小
- **更远的行**：
  - 浅灰色
  - 字号更小
- **渐变淡出**：字号和透明度从中心向两端递减，形成渐变效果

**3. 交互特性**
- **上下滑动**：弹性动画效果
- **振动反馈**：每次切换选项时触发振动
- **默认值**：当前系统时间
- **循环滚动**：
  - 1月往上滚动 → 12月
  - 12月往下滚动 → 1月
  - 其他数值同理循环

**4. 日期动态计算**
- 根据选中的年份和月份动态计算最大天数
- 当日期超出范围时：
  - 自动调整为该月最大日期
  - 立即刷新控件显示

**5. 技术实现要点**
- 使用 `LazyColumn` 实现垂直滚动
- 使用 `Vibrator` 或 `HapticFeedback` 提供触觉反馈
- 使用 `graphicsLayer` 实现字号和透明度渐变
- 监听滚动状态，自动吸附到最近项